---
title: "R Notebook"
output: html_notebook
---

# session info
```{r}
sessionInfo()
R version 4.4.0 (2024-04-24 ucrt)
Platform: x86_64-w64-mingw32/x64
Running under: Windows 10 x64 (build 19045)

Matrix products: default


locale:
[1] LC_COLLATE=English_United States.utf8  LC_CTYPE=English_United States.utf8    LC_MONETARY=English_United States.utf8
[4] LC_NUMERIC=C                           LC_TIME=English_United States.utf8    

time zone: Asia/Seoul
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] fuzzyjoin_0.1.6 protViz_0.7.9   nplyr_0.2.0     lubridate_1.9.4 forcats_1.0.0   stringr_1.5.1   dplyr_1.1.4     purrr_1.0.2     readr_2.1.5    
[10] tidyr_1.3.1     tibble_3.2.1    tidyverse_2.0.0 ggpubr_0.6.0    ggplot2_3.5.1  

loaded via a namespace (and not attached):
 [1] gtable_0.3.6      xfun_0.50         bslib_0.8.0       rstatix_0.7.2     tzdb_0.4.0        vctrs_0.6.5       tools_4.4.0       generics_0.1.3   
 [9] pkgconfig_2.0.3   assertthat_0.2.1  lifecycle_1.0.4   compiler_4.4.0    farver_2.1.2      textshaping_1.0.0 munsell_0.5.1     codetools_0.2-20 
[17] carData_3.0-5     htmltools_0.5.8.1 sass_0.4.9        yaml_2.3.10       Formula_1.2-5     pillar_1.10.1     car_3.1-3         jquerylib_0.1.4  
[25] cachem_1.1.0      abind_1.4-8       tidyselect_1.2.1  digest_0.6.37     stringi_1.8.4     labeling_0.4.3    cowplot_1.1.3     fastmap_1.2.0    
[33] grid_4.4.0        colorspace_2.1-0  cli_3.6.2         magrittr_2.0.3    utf8_1.2.4        broom_1.0.7       withr_3.0.2       scales_1.3.0     
[41] backports_1.5.0   timechange_0.3.0  rmarkdown_2.29    ggsignif_0.6.4    ragg_1.3.3        hms_1.1.3         evaluate_1.0.3    knitr_1.49       
[49] rlang_1.1.4       Rcpp_1.0.14       glue_1.7.0        rstudioapi_0.17.1 jsonlite_1.8.9    R6_2.5.1          systemfonts_1.2.1

```

# load required packages
```{r}
#install.packages("tidyverse")
library(tidyverse)
#install.packages("nplyr")
library(nplyr)
#install.packages("protViz")
library(protViz)
#install.packages("fuzzyjoin")
library(fuzzyjoin)
```
# extract modification of interest from .pin file
```{r}
# example by methylated BSA
pin <- read_delim("C:/Users/LHK/Documents/GitHub/met/230517_BSA_D3_Tm_stock.pin")


col_num <- pin %>% ncol() # original number of columns for export
  
# N-terminal modifications
pin <- pin %>%
  mutate(
    ScanNr = as.numeric(ScanNr), # change scan number to numeric value
    Nt_mod1 = str_locate(Peptide , "\\[")[,1],
    Nt_mod2 = if_else(Nt_mod1 == 3, str_extract(pin$Peptide ,"(?<=\\[).{1,12}(?=\\])"), "Free") %>% replace_na("Free"),
    Nt_mod2 = str_replace(Nt_mod2, "UNIMOD:122", "Formyl"),
    Nt_mod2 = str_replace(Nt_mod2, "UNIMOD:1", "Acetyl"),
    Nt_mod2 = str_replace(Nt_mod2, "UNIMOD:27", "pyroGluE"),
    Nt_mod2 = str_replace(Nt_mod2, "UNIMOD:28", "pyroGluQ"),
    Nt_mod2 = str_replace(Nt_mod2, "UNIMOD:56", "D3Acetyl"),
    Nt_mod2 = str_replace(Nt_mod2, "UNIMOD:34", "Methyl"),
    Nt_mod2 = str_replace(Nt_mod2, "UNIMOD:36", "Dimethyl"),
    Nt_mod2 = str_replace(Nt_mod2, "UNIMOD:37", "Trimethyl")
    )
  

# extract N-terminal modifications of interest + target & decoy from pin
pin_target <- pin %>%
  filter(Label == 1) %>%
  filter(Nt_mod2 %in% c("Acetyl", "Trimethyl", "Formyl", "Dimethyl", "Methyl"))
  
pin_decoy <- pin %>%
  filter(Label == -1) %>%
  filter(Nt_mod2 %in% c("Acetyl", "Trimethyl", "Formyl", "Dimethyl", "Methyl"))

pin_combined <- bind_rows(pin_target, pin_decoy) %>%
  select(1:all_of(col_num)) # change to original number of columns for export

write_tsv(pin_combined, "C:/Users/LHK/Documents/GitHub/met/target_decoy.pin")
```

# 1% false discovery rate from percolator file
```{r}
# target and decoy files generated by percolator v3.06 using percolator_batch_decoy.bat

target <- read_delim("C:/Users/LHK/Documents/GitHub/met/target.psms")
decoy <- read_delim("C:/Users/LHK/Documents/GitHub/met/decoy.psms")

colnum <- ncol(target) # original number of columns for export

# label target and decoy before combining dataframe 

target$label <- 1
decoy$label <- 2

target_decoy <- full_join(target, decoy)

# 1% FDR

target_decoy <- target_decoy %>% # accumulate number of target and decoys
  arrange(desc(score)) %>%
  mutate(
    target_max = str_count(label, "1"),
    target_max = replace_na(target_max, 0),
    target_max = cumsum(target_max),
    decoy_max = str_count(label, "2"),
    decoy_max = replace_na(decoy_max, 0),
    decoy_max = cumsum(decoy_max)
  )

target_decoy <- target_decoy %>% # calculate FDR
  rowwise() %>%
  mutate(
    fdr = round(decoy_max*2/sum(target_max, decoy_max)*100, digits = 2)
  ) %>%
  ungroup()

cutoff <- target_decoy %>% # cut off by 1% FDR
  filter(fdr < 1)

cutoff1 <- cutoff %>%
  select(1:all_of(colnum)) # original number of columns for export

write_tsv(cutoff1, "C:/Users/LHK/Documents/GitHub/met/bsa_tm_fdr.psms") # export percolator file
```
# merge pin, msgf result to percolator file
```{r}
perc <- read_delim("C:/Users/LHK/Documents/GitHub/met/bsa_tm_fdr.psms", show_col_types = FALSE) # read percolator file

perc <- perc %>% # extract N-term modifications
  mutate(
    Nmod = str_locate(perc$peptide, "\\[")[,1],
    Nmod1 = if_else(Nmod == 3, str_extract(perc$peptide,"(?<=\\[).{1,10}(?=\\])"), "Free") %>% replace_na("Free"),
   Nmod2 = str_replace(Nmod1, "UNIMOD:122", "Formyl"),
   Nmod2 = str_replace(Nmod2, "UNIMOD:1", "Acetyl"),
   Nmod2 = str_replace(Nmod2, "UNIMOD:27", "pyroGluE"),
   Nmod2 = str_replace(Nmod2, "UNIMOD:28", "pyroGluQ"),
   Nmod2 = str_replace(Nmod2, "UNIMOD:56", "D3Acetyl"),
   Nmod2 = str_replace(Nmod2, "UNIMOD:34", "Methyl"),
   Nmod2 = str_replace(Nmod2, "UNIMOD:36", "Dimethyl"),
   Nmod2 = str_replace(Nmod2, "UNIMOD:37", "Trimethyl")
  )
    
  
perc <- perc %>% # extract scan, strip sequence
  mutate(
    scan = str_extract(PSMId, "(?<=SII\\_)[0-9]+(?=\\_{1})")|>as.numeric(),
    pep_raw = str_sub(peptide, start = 3, end = str_length(peptide)-2),
    pep_raw = str_replace_all(pep_raw, "K\\[UNIMOD:56\\]", "K"),
    pep_raw = str_replace_all(pep_raw, "\\[UNIMOD:4\\]", "\\"),
    pep_raw = str_replace_all(pep_raw, "\\[UNIMOD:35\\]", "\\"),
    pep_raw = str_replace(pep_raw, "\\[UNIMOD:122\\]", "\\"),
    pep_raw = str_replace(pep_raw, "\\[UNIMOD:1\\]", "\\"),
    pep_raw = str_replace(pep_raw, "\\[UNIMOD:27\\]", "\\"),
    pep_raw = str_replace(pep_raw, "\\[UNIMOD:28\\]", "\\"),
    pep_raw = str_replace(pep_raw, "\\[UNIMOD:56\\]", "\\"),
    pep_raw = str_replace(pep_raw, "\\[UNIMOD:34\\]", "\\"),
    pep_raw = str_replace(pep_raw, "\\[UNIMOD:36\\]", "\\"),
    pep_raw = str_replace(pep_raw, "\\[UNIMOD:37\\]", "\\"),
    pep_scan = str_c(pep_raw, scan, sep = "_"),
    pep_scan_Nmod = str_c(pep_scan, Nmod2, sep = "_")
  )
      
# extract info from pin
pin <- read_delim("C:/Users/LHK/Documents/GitHub/met/target_decoy.pin")


  col_num <- pin %>% ncol()
  
  ## extract N-term from pin ##
  pin <- pin %>%
    mutate(
      ScanNr = as.numeric(ScanNr),
      Nt_mod1 = str_locate(Peptide , "\\[")[,1],
      Nt_mod2 = if_else(Nt_mod1 == 3, str_extract(pin$Peptide ,"(?<=\\[).{1,12}(?=\\])"), "Free") %>% replace_na("Free"),
      Nt_mod2 = str_replace(Nt_mod2, "UNIMOD:122", "Formyl"),
      Nt_mod2 = str_replace(Nt_mod2, "UNIMOD:1", "Acetyl"),
      Nt_mod2 = str_replace(Nt_mod2, "UNIMOD:27", "pyroGluE"),
      Nt_mod2 = str_replace(Nt_mod2, "UNIMOD:28", "pyroGluQ"),
      Nt_mod2 = str_replace(Nt_mod2, "UNIMOD:56", "D3Acetyl"),
      Nt_mod2 = str_replace(Nt_mod2, "UNIMOD:34", "Methyl"),
      Nt_mod2 = str_replace(Nt_mod2, "UNIMOD:36", "Dimethyl"),
      Nt_mod2 = str_replace(Nt_mod2, "UNIMOD:37", "Trimethyl")
    )

# pep_scan & pep_MSGF for pin
  
  pin <- pin %>%
    mutate(
      pep_MSGF = str_replace_all(Peptide, "K\\[UNIMOD:56\\]", "K\\+45\\.029"),
      pep_MSGF = str_replace_all(pep_MSGF, "\\[UNIMOD:4\\]", "\\+57\\.021"),
      pep_MSGF = str_replace_all(pep_MSGF, "\\[UNIMOD:35\\]", "\\+15\\.995"),
      pep_MSGF = str_replace(pep_MSGF, "\\[UNIMOD:122\\]", "\\+27\\.995"),
      pep_MSGF = str_replace(pep_MSGF, "\\[UNIMOD:1\\]", "\\+42\\.011"),
      pep_MSGF = str_replace(pep_MSGF, "\\[UNIMOD:27\\]", "\\-18\\.011"),
      pep_MSGF = str_replace(pep_MSGF, "\\[UNIMOD:28\\]", "\\-17\\.027"),
      pep_MSGF = str_replace(pep_MSGF, "\\[UNIMOD:56\\]", "\\+45\\.029"),
      pep_MSGF = str_replace(pep_MSGF, "\\[UNIMOD:34\\]", "\\+14\\.016"),
      pep_MSGF = str_replace(pep_MSGF, "\\[UNIMOD:36\\]", "\\+28\\.031"),
      pep_MSGF = str_replace(pep_MSGF, "\\[UNIMOD:37\\]", "\\+42\\.047")
    )
  
  pin <- pin %>%
    mutate(
      pep_raw = str_sub(Peptide, start = 3, end = str_length(Peptide)-2),
      pep_raw = str_replace_all(pep_raw, "K\\[UNIMOD:56\\]", "K"),
      pep_raw = str_replace_all(pep_raw, "\\[UNIMOD:4\\]", "\\"),
      pep_raw = str_replace_all(pep_raw, "\\[UNIMOD:35\\]", "\\"),
      pep_raw = str_replace(pep_raw, "\\[UNIMOD:122\\]", "\\"),
      pep_raw = str_replace(pep_raw, "\\[UNIMOD:1\\]", "\\"),
      pep_raw = str_replace(pep_raw, "\\[UNIMOD:27\\]", "\\"),
      pep_raw = str_replace(pep_raw, "\\[UNIMOD:28\\]", "\\"),
      pep_raw = str_replace(pep_raw, "\\[UNIMOD:56\\]", "\\"),
      pep_raw = str_replace(pep_raw, "\\[UNIMOD:34\\]", "\\"),
      pep_raw = str_replace(pep_raw, "\\[UNIMOD:36\\]", "\\"),
      pep_raw = str_replace(pep_raw, "\\[UNIMOD:37\\]", "\\")
    )
  
  pin <- pin %>%
    mutate(
      pep_len = str_length(pep_raw),
      scan = str_sub(SpecId, start = str_locate(SpecId, "SII")[,2]+2, end = str_locate(SpecId, "SII")[,2]+6),
      scan = str_replace(scan, "\\_","") %>% as.numeric(),
      pep_scan = paste(pep_raw, scan, sep = "_"),
      pep_scan_Nmod = paste(pep_scan, Nt_mod2, sep = "_"),
      pep_MSGF = str_sub(pep_MSGF, start = 3, end = -3),
      pep_MSGF = paste(pep_MSGF, scan, sep = "_")
    )
  
  pin <- pin %>% group_by(ScanNr) %>%
    mutate(scan_row = row_number(ScanNr)) %>% ungroup()


# extract proteins from pin for perc
{
  pin_prot <- pin %>% dplyr::select(pep_MSGF, pep_scan_Nmod, Label, Proteins)
  perc_prot <- perc %>%
    dplyr::left_join(pin_prot, by = "pep_scan_Nmod", relationship = "one-to-many")
  perc_prot <- perc_prot %>%
    mutate(
      prot_num = str_count(Proteins, "\\s")+1
    ) %>%
    group_by(pep_scan_Nmod) %>%
    mutate(
      rows = dplyr::row_number(pep_scan_Nmod)
    )
  
  perc_prot <- perc_prot %>% filter(rows == 1) %>% ungroup()
  perc_prot <- perc_prot %>% select(-c(rows))
}
```

# extract msgf for matching with perc_prot
```{r}
readr::read_tsv("C:/Users/LHK/Documents/GitHub/met/230517_BSA_D3_Tm_stock.tsv") -> msgf_output

{
  msgf_output %>% rename(SpecFile = "#SpecFile") -> msgf_output
  
# peptide with no cleavage site, peptide raw sequence
msgf_output <- msgf_output %>%
    mutate(
    pep_no_p1 = substr(Peptide, start = 3, stop = nchar(Peptide)-2),
    pep_raw = str_replace_all(pep_no_p1, c("[[:punct:]]" = "", "[[:digit:]]" = "", "\\+"= "", "\\-" = ""))
    )
  
  ##remove N-term, C-term for assign them 
msgf_output <- msgf_output %>%
    mutate(
      NtermMod = str_extract(pep_no_p1, "^\\+[0-9]+\\.[0-9]+|^\\-[0-9]+\\.[0-9]+"),
      CtermMod = str_extract(pep_no_p1, "\\+[0-9]+\\.[0-9]+$|\\-[0-9]+\\.[0-9]+$"),
      NtermMod = as.numeric(str_remove(NtermMod, "^\\+|^\\-")),
      CtermMod = as.numeric(str_remove(CtermMod, "\\+$|\\-$")),
      CtermMod = str_replace(CtermMod, "45.029", "\ "),
      CtermMod = str_replace(CtermMod, "57.021", "\ "),
      CtermMod = if_else(is.na(CtermMod), "\ ", CtermMod)
    ) 
  
  ## change to monoisotopic ## 
  
  ## assign N-term, C-term names
  msgf_output <- msgf_output %>%
    mutate(
      Nt_assign = str_replace_all(NtermMod, c("42.011" = "Acetyl",
                                              "42.047" = "Trimethyl",
                                              "45.029" = "D3Acetyl",
                                              "18.011" = "pyroGluE",
                                              "28.031" = "Dimethyl",
                                              "17.027" = "pyroGluQ",
                                              "14.016" = "Methyl",
                                              "27.995" = "Formyl")),
      Nt_assign = replace_na(Nt_assign, "Free"),
      NtermMod = str_replace_all(NtermMod, c("42.011" = "42.010565",
                                             "42.047" = "42.046950",
                                             "45.029" = "45.029395",
                                             "18.011" = "18.010565",
                                             "28.031" = "28.031300",
                                             "17.027" = "17.026549",
                                             "14.016" = "14.015650",
                                             "27.995" = "27.994915")),
      NtermMod = as.numeric(NtermMod),
      CtermMod = str_replace(CtermMod, "\ ", "0")#,
      #Ct_assign = if_else(CtermMod == "6.02", "Heavy", "Light"), # code for SILAC data
      #CtermMod = as.numeric(str_replace(CtermMod, "6.02", "6.020129"))
      )
  
  msgf_output <- msgf_output %>%
    mutate(
      pep_scan = str_c(pep_raw, ScanNum, sep = "_"),
      pep_scan_Nmod = str_c(pep_scan, Nt_assign, sep = "_"),
      pep_no_p1_scan = str_c(pep_no_p1, ScanNum, sep = "_")
    )
  
  # extracting ppm for near-isobaric modifications
{
  msgf_perc <- msgf_output %>%
    select(pep_scan, pep_scan_Nmod, pep_no_p1, pep_no_p1_scan, Charge, Precursor, `PrecursorError(ppm)`) %>%
    rename("ppm" = "PrecursorError(ppm)")
  
  
  perc_prot <- perc_prot %>%
    left_join(msgf_perc, by = c("pep_MSGF" = "pep_no_p1_scan")) %>% ungroup()
  
  perc_prot <- perc_prot %>%
    mutate(
      ppm_near_iso = case_when(
        Nmod2 == "Acetyl" ~ -((42.046950-42.010565)/Charge/Precursor*1e6 - ppm),
        Nmod2 == "Trimethyl" ~ (42.046950-42.010565)/Charge/Precursor*1e6 + ppm,
        Nmod2 == "Formyl" ~ -((28.031300-27.994915)/Charge/Precursor*1e6 - ppm),
        Nmod2 == "Dimethyl" ~ (28.031300-27.994915)/Charge/Precursor*1e6 + ppm
      )
    )
}
}
```


# merge mgf file to percolator file
```{r}
# extract mgf : turning .mgf file into a dataframe
readr::read_lines("C:/Users/LHK/Documents/GitHub/met/230517_BSA_D3_Tm_stock.mgf") -> mgf_file
{
  tibble(
    title=mgf_file[str_detect(mgf_file,"TITLE\\=")],
    rtinseconds=mgf_file[str_detect(mgf_file,"RTINSECONDS\\=")],
    pepmass=mgf_file[str_detect(mgf_file,"PEPMASS\\=")],
    start = str_which(mgf_file,"BEGIN IONS"),
    end = str_which(mgf_file,"END IONS")
  ) -> mgf_df
  
  mgf_df %>%
    mutate(scannumber= as.numeric(str_extract(title,"(?<=\\.)[0-9]+(?=\\.)"))) %>%
    mutate(rtinseconds = as.numeric(str_extract(rtinseconds,"(?<=RTINSECONDS\\=).+"))) %>%
    mutate(pepmass = str_extract(pepmass,"(?<=PEPMASS\\=).+")) -> mgf_df
  mgf_df %>% separate(col = pepmass, into = c("pepmass","pepint"), sep = " ") -> mgf_df
  
  #.$ion_mz ##[start:end,] ## ~ insert function (tilde) lambda function
  
  mgf_df %>% mutate(ion_mz = map2(start,end, ~ mgf_file[seq(from = .x+4, to = .y-1)])) %>% 
    mutate(ion_int = map(ion_mz, ~ str_extract(.x, "(?<=[:blank:]).+"))) %>%
    mutate(ion_mz = map(ion_mz, ~ str_extract(.x, ".+(?=[:blank:])"))) %>%
    mutate(ion = map2(ion_mz,ion_int, ~ tibble(ion_mz = .x, ion_int = .y))) -> mgf_df
  
  mgf_df %>% 
    mutate(ion_int = map(ion_int, ~as.numeric(.x))) %>%
    mutate(ion_mz = map(ion_mz, ~as.numeric(.x))) -> mgf_df
}

## combine perc_prot and mgf_df
{
mgf_df <- mgf_df %>%
  select(-c(start,end,ion_mz,ion_int)
        ) %>%
  mutate(
    ion = map(ion, \(x) mutate(x,across(everything(),as.numeric)))
    )

  perc_prot %>%
  left_join(mgf_df, by= c("scan"="scannumber")) -> perc_prot
}
```

# fragmentation
```{r}
# function for theoretical fragment m/z with n-term
{
  FragmentPeptide2 <-function (sequence, fragments = "by", IAA = TRUE, N15 = FALSE, nterm  = 0,
                               custom = list()) 
  {
    results_list <- vector("list")
    for (sequence_number in 1:length(sequence)) {
      peptide_vector <- strsplit(sequence[sequence_number], 
                                 split = "")[[1]]
      peptide_length <- length(peptide_vector)
      if (peptide_length < 2) 
        stop("sequence must contain two or more residues")
      C <- 12
      H <- 1.0078250321
      O <- 15.9949146221
      S <- 31.97207069
      N <- ifelse(N15 == TRUE, 15.0001088984, 14.0030740052)
      proton <- 1.007276466
      electron <- 0.00054857990943
      residueMass <- function(residue) {
        if (residue == "A") 
          mass = C * 3 + H * 5 + N + O
        if (residue == "R") 
          mass = C * 6 + H * 12 + N * 4 + O
        if (residue == "N") 
          mass = C * 4 + H * 6 + N * 2 + O * 2
        if (residue == "D") 
          mass = C * 4 + H * 5 + N + O * 3
        if (residue == "E") 
          mass = C * 5 + H * 7 + N + O * 3
        if (residue == "Q") 
          mass = C * 5 + H * 8 + N * 2 + O * 2
        if (residue == "G") 
          mass = C * 2 + H * 3 + N + O
        if (residue == "H") 
          mass = C * 6 + H * 7 + N * 3 + O
        if (residue == "I") 
          mass = C * 6 + H * 11 + N + O
        if (residue == "L") 
          mass = C * 6 + H * 11 + N + O
        if (residue == "K") 
          mass = C * 6 + H * 12 + N * 2 + O
        if (residue == "M") 
          mass = C * 5 + H * 9 + N + O + S
        if (residue == "F") 
          mass = C * 9 + H * 9 + N + O
        if (residue == "P") 
          mass = C * 5 + H * 7 + N + O
        if (residue == "S") 
          mass = C * 3 + H * 5 + N + O * 2
        if (residue == "T") 
          mass = C * 4 + H * 7 + N + O * 2
        if (residue == "W") 
          mass = C * 11 + H * 10 + N * 2 + O
        if (residue == "Y") 
          mass = C * 9 + H * 9 + N + O * 2
        if (residue == "V") 
          mass = C * 5 + H * 9 + N + O
        if (residue == "C" & IAA == FALSE) 
          mass = C * 3 + H * 5 + N + O + S
        if (residue == "C" & IAA == TRUE) 
          mass <- ifelse(N15 == FALSE, C * 5 + H * 8 + 
                           N * 2 + O * 2 + S, C * 5 + H * 8 + N + 14.0030740052 + 
                           O * 2 + S)
        if (length(custom) != 0) 
          for (i in 1:length(custom$code)) if (residue == 
                                               custom$code[i]) 
            mass = custom$mass[i]
        return(mass)
      }
      masses <- sapply(peptide_vector, residueMass)
      pm <- sum(masses)
      p1 <- round(pm+nterm + H * 2 + O + proton, digits = 3)
      p2 <- round((pm+nterm + H * 2 + O + (2 * proton))/2, digits = 3)
      p3 <- round((pm+nterm + H * 2 + O + (3 * proton))/3, digits = 3)
      if (fragments == "by") {
        b1 <- vector(mode = "numeric", length = 0)
        b2 <- vector(mode = "numeric", length = 0)
        bs <- vector(mode = "character", length = 0)
        bi <- vector(mode = "integer", length = 0)
        y1 <- vector(mode = "numeric", length = 0)
        y2 <- vector(mode = "numeric", length = 0)
        ys <- vector(mode = "character", length = 0)
        yi <- vector(mode = "integer", length = 0)
        for (i in 1:(peptide_length - 1)) {
          mass <- sum(masses[1:i])+nterm
          b1[i] <- round(mass + proton, digits = 3)
          b2[i] <- round((b1[i] + proton)/2, digits = 3)
          bs[i] <- paste(peptide_vector[1:i], collapse = "")
          bi[i] <- i
        }
        for (j in 2:peptide_length) {
          mass <- sum(masses[j:peptide_length])
          y1[j - 1] <- round(mass + H * 2 + O + proton, 
                             digits = 3)
          y2[j - 1] <- round((y1[j - 1] + proton)/2, digits = 3)
          ys[j - 1] <- paste(peptide_vector[j:peptide_length], 
                             collapse = "")
          yi[j - 1] <- peptide_length - j + 1
        }
        ms1seq <- rep(sequence[sequence_number], times = ((2 * 
                                                             (length(bi))) + (2 * (length(yi)))))
        ms1z1 <- rep(p1, times = ((2 * (length(bi))) + (2 * 
                                                          (length(yi)))))
        ms1z2 <- rep(p2, times = ((2 * (length(bi))) + (2 * 
                                                          (length(yi)))))
        ms1z3 <- rep(p3, times = ((2 * (length(bi))) + (2 * 
                                                          (length(yi)))))
        ms2seq <- c(rep(bs, times = 2), rep(ys, times = 2))
        b1.type <- paste("[b", bi, "]1+", sep = "")
        b2.type <- paste("[b", bi, "]2+", sep = "")
        y1.type <- paste("[y", yi, "]1+", sep = "")
        y2.type <- paste("[y", yi, "]2+", sep = "")
        ms2type <- c(b1.type, b2.type, y1.type, y2.type)
        ms2mz <- c(b1, b2, y1, y2)
      }
      if (fragments == "cz") {
        c1 <- vector(mode = "numeric", length = 0)
        c2 <- vector(mode = "numeric", length = 0)
        cs <- vector(mode = "character", length = 0)
        ci <- vector(mode = "integer", length = 0)
        z1 <- vector(mode = "numeric", length = 0)
        z2 <- vector(mode = "numeric", length = 0)
        zs <- vector(mode = "character", length = 0)
        zi <- vector(mode = "integer", length = 0)
        for (i in 1:(peptide_length - 1)) {
          mass <- sum(masses[1:i])
          c1[i] <- round(mass + 3 * H + N + proton, digits = 3)
          c2[i] <- round((c1[i] + proton)/2, digits = 3)
          cs[i] <- paste(peptide_vector[1:i], collapse = "")
          ci[i] <- i
        }
        for (j in 2:peptide_length) {
          mass <- sum(masses[j:peptide_length])
          z1[j - 1] <- round(mass + O - N, digits = 3)
          z2[j - 1] <- round((z1[j - 1] + proton)/2, digits = 3)
          zs[j - 1] <- paste(peptide_vector[j:peptide_length], 
                             collapse = "")
          zi[j - 1] <- peptide_length - j + 1
        }
        ms1seq <- rep(sequence[sequence_number], times = ((2 * 
                                                             (length(ci))) + (2 * (length(zi)))))
        ms1z1 <- rep(p1, times = ((2 * (length(ci))) + (2 * 
                                                          (length(zi)))))
        ms1z2 <- rep(p2, times = ((2 * (length(ci))) + (2 * 
                                                          (length(zi)))))
        ms1z3 <- rep(p3, times = ((2 * (length(ci))) + (2 * 
                                                          (length(zi)))))
        ms2seq <- c(rep(cs, times = 2), rep(zs, times = 2))
        c1.type <- paste("[c", ci, "]1+", sep = "")
        c2.type <- paste("[c", ci, "]2+", sep = "")
        z1.type <- paste("[z", zi, "]1+", sep = "")
        z2.type <- paste("[z", zi, "]2+", sep = "")
        ms2type <- c(c1.type, c2.type, z1.type, z2.type)
        ms2mz <- c(c1, c2, z1, z2)
      }
      results_list[[sequence_number]] <- data.frame(ms1seq, 
                                                    ms1z1, ms1z2, ms1z3, ms2seq, ms2type, ms2mz)
    }
    return(as.data.frame(do.call("rbind", results_list)))
  }
  
}
```

# modified peptides for fragmentation function
```{r}
# nt-mod extraction & extract and remove decoy
{
  perc_prot %>% 
    mutate(
      nmod = str_extract(pep_no_p1,"(?<=^[\\+\\-])[0-9]+\\.[0-9]+")
    ) %>%
    mutate(
      pep_raw_mod = str_replace_all(pep_no_p1,"M\\+15\\.995","m") %>% 
        str_replace_all("K\\+45\\.029","k") %>% 
        str_replace_all("C\\+57\\.021","c") %>% 
        str_extract("[:alpha:]+")
    ) %>% 
    mutate(
      nmod1 = case_when(
        nmod == "42.011" ~ 42.010565, # monoisotopic mass for N-term mod from search engine
        nmod == "42.047" ~ 42.046950,
        nmod == "45.029" ~ 45.029395,
        nmod == "18.011" ~ -18.010565,
        nmod == "17.027" ~ -17.026549,
        nmod == "28.031" ~ 28.031300,
        nmod == "14.016" ~ 14.015650,
        nmod == "27.995" ~ 27.994915,
        .default = NA_real_
      )
      ) %>%
    mutate(
      nmod2 = case_when(
        nmod == "42.011" ~ 42.046950, # monoisotopic mass for counterpart N-term mod 
        nmod == "42.047" ~ 42.010565,
        nmod == "45.029" ~ 45.029395,
        nmod == "18.011" ~ -18.010565,
        nmod == "17.027" ~ -17.026549,
        nmod == "28.031" ~ 27.994915,
        nmod == "14.016" ~ 14.015650,
        nmod == "27.995" ~ 28.031300,
        .default = NA_real_
    )
    ) -> perc_prot
  
  perc_prot <- filter(perc_prot, !is.na(pep_raw_mod))
}
```

# calculate theoretical m/z of fragments
```{r}
{
  perc_prot %>% 
    mutate(
      theo_frag1 = map2(
        pep_raw_mod,
        nmod1,
        \(x,y) FragmentPeptide2(
          x,
          fragments = "by",
          nterm=y,
          IAA=FALSE,
          custom = list(
            code = c("m","c","k"),
            mass = c(131.040485+15.994915,103.009185+57.021464,128.09496+45.029395)
          )
        )
      )
    ) -> perc_prot
  
  perc_prot %>% 
    mutate(
      theo_frag2 = map2(
        pep_raw_mod,
        nmod2,
        \(x,y) FragmentPeptide2(
          x,
          fragments = "by",
          nterm=y,
          IAA=FALSE,
          custom = list(
            code = c("m","c","k"),
            mass = c(131.040485+15.994915,103.009185+57.021464,128.09496+45.029395)
          )
        )
      )
    ) -> perc_prot
}
```
# add a-ion to theoretical
```{r}
perc_prot <- perc_prot|>
  mutate(
    theo_frag1_a = map(theo_frag1, ~.x[str_detect(.x$ms2type, "b"),]),
    theo_frag2_a = map(theo_frag2, ~.x[str_detect(.x$ms2type, "b"),]),
    theo_frag1_a = map(theo_frag1_a, ~.x|>mutate(ms2type = str_replace(.x$ms2type, "b", "a"),
                                                 charge = str_extract(.x$ms2type, "[0-9]+(?=\\+)")|>as.numeric(),
                                                 ms2mz = if_else(charge>1, (ms2mz+1.0078250321-27.9949146221)/charge, ms2mz-27.9949146221))),
    theo_frag2_a = map(theo_frag2_a, ~.x|>mutate(ms2type = str_replace(.x$ms2type, "b", "a"),
                                                 charge = str_extract(.x$ms2type, "[0-9]+(?=\\+)")|>as.numeric(),
                                                 ms2mz = if_else(charge>1, (ms2mz+1.0078250321-27.9949146221)/charge, ms2mz-27.9949146221)))
  )

perc_prot <- perc_prot|>
  mutate(
    theo_frag1 = map2(theo_frag1, theo_frag1_a,~bind_rows(.x,.y|>select(-c("charge")))),
    theo_frag2 = map2(theo_frag2, theo_frag2_a,~bind_rows(.x,.y|>select(-c("charge")))),
  )
```
# matching theoretical with observed m/z
```{r}
{
  perc_prot %>% # n-term modifications from search engine
    mutate(
      frag_matched1 = map2(
        ion,
        theo_frag1,
        \(x,y) fuzzy_left_join(
          x,y,
          by = c("ion_mz" = "ms2mz"),
          match_fun = ~between(.x-.y,-0.05,0.05)
        ),
        .progress = TRUE
      )
    ) -> perc_prot
  
  perc_prot %>% # counterpart n-term modifications
    mutate(
      frag_matched2 = map2(
        ion,
        theo_frag2,
        \(x,y) fuzzy_left_join(
          x,y,
          by = c("ion_mz" = "ms2mz"),
          match_fun = ~between(.x-.y,-0.05,0.05)
        ),
        .progress = TRUE
      )
    ) -> perc_prot
}
```
# calculate ppm, count ions, statistical tests, scoring
```{r}
# ppm function 
{
  ppm <- function(x,y){
    x1 <- (y-x)/x*1000000 %>% unlist()
    return(x1)
  }
}

# calculate ppm 
{
  perc_prot <- perc_prot %>%
    nest_mutate(frag_matched1,
                ppm = ppm(
                    ms2mz,ion_mz)
                ) %>%
    nest_drop_na(frag_matched1, ppm)|> # unmatched observed m/z removed
    nest_group_by(frag_matched1, ion_mz)|>
    nest_filter(frag_matched1, abs(ppm) == min(abs(ppm)))|> # remove fragments matched to same m/z
    nest_ungroup(frag_matched1)
    
  
    
  perc_prot <- perc_prot %>%
    nest_mutate(frag_matched2,
                ppm = ppm(
                  ms2mz,ion_mz)
    ) %>%
    nest_drop_na(frag_matched2, ppm)|> # unmatched observed m/z removed
    nest_group_by(frag_matched2, ion_mz)|>
    nest_filter(frag_matched2, abs(ppm) == min(abs(ppm)))|> # remove fragments matched to same m/z
    nest_ungroup(frag_matched2)
}


# count a, b, y ions 
perc_prot <- perc_prot|>
  mutate(
    count_b_search = map(frag_matched1, ~.x[str_detect(.x$ms2type, "b"),]|>nrow())|>unlist(),
    count_b_test = map(frag_matched2, ~.x[str_detect(.x$ms2type, "b"),]|>nrow())|>unlist(),
    count_a_search = map(frag_matched1, ~.x[str_detect(.x$ms2type, "a"),]|>nrow())|>unlist(),
    count_a_test = map(frag_matched2, ~.x[str_detect(.x$ms2type, "a"),]|>nrow())|>unlist(),
    count_y = map(frag_matched1, ~.x[str_detect(.x$ms2type, "y"),]|>nrow())|>unlist(),
    count_ab_search = count_b_search + count_a_search,
    count_ab_test = count_b_test + count_a_test,
    t_test_able_a = if_else(
      count_ab_search > 1 & count_ab_test > 1 & count_y > 1, "able", "unable" 
    ),
    t_test_able = if_else(
      count_b_search > 1 & count_b_test > 1 & count_y > 1, "able", "unable" 
    )
  )

# statistical tests
{
# students' t-test
{
  t_test_student <- function(x){
    b <- x[str_extract(x$ms2type,"[:alpha:]") == "b" | str_extract(x$ms2type,"[:alpha:]") == "a", "ppm"]
    y <- x[str_extract(x$ms2type,"[:alpha:]") == "y", "ppm"]
    x1 <- tryCatch(t.test(b, y, var.equal = TRUE), error = function(e) return(1))
    return(x1)
  }
}

perc_prot %>%
  mutate(
    p_search_student = map(frag_matched1, \(x) t_test_student(x) %>% unlist()),
    p_test_student = map(frag_matched2, \(x) t_test_student(x) %>% unlist()),
    p_search_student = map(p_search_student, \(x) nth(x, 3)) %>% unlist() %>% as.numeric(),
    p_test_student = map(p_test_student, \(x) nth(x, 3)) %>% unlist() %>% as.numeric()
  ) -> perc_prot
    
perc_prot %>%
  mutate(
    TA_score_student = if_else(is.na(p_search_student) | is.na(p_test_student), NA,
                       if_else(nmod == 42.011 & !is.na(p_search_student) & !is.na(p_test_student),
                       log10(p_test_student)-log10(p_search_student),
                       if_else(nmod == 42.047 & !is.na(p_search_student) & !is.na(p_test_student),
                               log10(p_search_student)-log10(p_test_student),NA)
                       )
    )
  ) -> perc_prot

perc_prot %>%
  mutate(
    DF_score_student = if_else(is.na(p_search_student) | is.na(p_test_student), NA,
                       if_else(nmod == 27.995 & !is.na(p_search_student) & !is.na(p_test_student),
                               log10(p_test_student)-log10(p_search_student),
                               if_else(nmod == 28.031 & !is.na(p_search_student) & !is.na(p_test_student),
                                       log10(p_search_student)-log10(p_test_student),NA)
                       )
    )
  ) -> perc_prot
}

{
# Welch's t-test
{
  t_test_welch <- function(x){
    b <- x[str_extract(x$ms2type,"[:alpha:]") == "b" | str_extract(x$ms2type,"[:alpha:]") == "a", "ppm"]
    y <- x[str_extract(x$ms2type,"[:alpha:]") == "y", "ppm"]
    x1 <- tryCatch(t.test(b, y, var.equal = FALSE), error = function(e) return(1))
    return(x1)
  }
}

perc_prot %>%
  mutate(
    p_search_welch = map(frag_matched1, \(x) t_test_welch(x) %>% unlist()),
    p_test_welch = map(frag_matched2, \(x) t_test_welch(x) %>% unlist()),
    p_search_welch = map(p_search_welch, \(x) nth(x, 3)) %>% unlist() %>% as.numeric(),
    p_test_welch = map(p_test_welch, \(x) nth(x, 3)) %>% unlist() %>% as.numeric()
  ) -> perc_prot
    
perc_prot %>%
  mutate(
    TA_score_welch = if_else(is.na(p_search_welch) | is.na(p_test_welch), NA,
                       if_else(nmod == 42.011 & !is.na(p_search_welch) & !is.na(p_test_welch),
                       log10(p_test_welch)-log10(p_search_welch),
                       if_else(nmod == 42.047 & !is.na(p_search_welch) & !is.na(p_test_welch),
                               log10(p_search_welch)-log10(p_test_welch),NA)
                       )
    )
  ) -> perc_prot

perc_prot %>%
  mutate(
    DF_score_welch = if_else(is.na(p_search_welch) | is.na(p_test_welch), NA,
                       if_else(nmod == 27.995 & !is.na(p_search_welch) & !is.na(p_test_welch),
                               log10(p_test_welch)-log10(p_search_welch),
                               if_else(nmod == 28.031 & !is.na(p_search_welch) & !is.na(p_test_welch),
                                       log10(p_search_welch)-log10(p_test_welch),NA)
                       )
    )
  ) -> perc_prot
}

{
# Mann-Whitney U test 
{
  mw_test <- function(x){
    b <- x[str_extract(x$ms2type,"[:alpha:]") == "b" | str_extract(x$ms2type,"[:alpha:]") == "a", "ppm"]|>pull()
    y <- x[str_extract(x$ms2type,"[:alpha:]") == "y", "ppm"]|>pull()
    x1 <- tryCatch(wilcox.test(b,y), error = function(e) return(1))
    return(x1)
  }
}

perc_prot %>%
  mutate(
    p_search_mw = map(frag_matched1, \(x) mw_test(x) %>% unlist()),
    p_test_mw = map(frag_matched2, \(x) mw_test(x) %>% unlist()),
    p_search_mw = map(p_search_mw, \(x) nth(x, 2)) %>% unlist() %>% as.numeric(),
    p_test_mw = map(p_test_mw, \(x) nth(x, 2)) %>% unlist() %>% as.numeric()
  ) -> perc_prot
    
perc_prot %>%
  mutate(
    TA_score_mw = if_else(is.na(p_search_mw) | is.na(p_test_mw), NA,
                       if_else(nmod == 42.011 & !is.na(p_search_mw) & !is.na(p_test_mw),
                       log10(p_test_mw)-log10(p_search_mw),
                       if_else(nmod == 42.047 & !is.na(p_search_mw) & !is.na(p_test_mw),
                               log10(p_search_mw)-log10(p_test_mw),NA)
                       )
    )
  ) -> perc_prot

perc_prot %>%
  mutate(
    DF_score_mw = if_else(is.na(p_search_mw) | is.na(p_test_mw), NA,
                       if_else(nmod == 27.995 & !is.na(p_search_mw) & !is.na(p_test_mw),
                               log10(p_test_mw)-log10(p_search_mw),
                               if_else(nmod == 28.031 & !is.na(p_search_mw) & !is.na(p_test_mw),
                                       log10(p_search_mw)-log10(p_test_mw),NA)
                       )
    )
  ) -> perc_prot
}
```


# reassigning Nt-mod according to score
```{r}
{
  perc_prot <- perc_prot %>%
    mutate(
      nmod_student = case_when(
        Nmod2 == "Acetyl" & TA_score_student < -1.3 ~ "Acetyl",
        Nmod2 == "Acetyl" & between(TA_score_student, -1.3, 1.3) ~ "Acetyl",
        Nmod2 == "Acetyl" & is.na(TA_score_student) ~ "Acetyl",
        Nmod2 == "Acetyl" & TA_score_student > 1.3 ~ "Trimethyl",
        Nmod2 == "Trimethyl" & TA_score_student > 1.3 ~ "Trimethyl",
        Nmod2 == "Trimethyl" & between(TA_score_student, -1.3, 1.3) ~ "Trimethyl",
        Nmod2 == "Trimethyl" & is.na(TA_score_student) ~ "Trimethyl",
        Nmod2 == "Trimethyl" & TA_score_student < -1.3 ~ "Acetyl",
        Nmod2 == "Formyl" & DF_score_student < -1.3 ~ "Formyl",
        Nmod2 == "Formyl" & between(DF_score_student, -1.3, 1.3) ~ "Formyl",
        Nmod2 == "Formyl" & is.na(DF_score_student) ~ "Formyl",
        Nmod2 == "Formyl" & DF_score_student > 1.3 ~ "Dimethyl",
        Nmod2 == "Dimethyl" & DF_score_student > 1.3 ~ "Dimethyl",
        Nmod2 == "Dimethyl" & between(DF_score_student, -1.3, 1.3) ~ "Dimethyl",
        Nmod2 == "Dimethyl" & is.na(DF_score_student) ~ "Dimethyl",
        Nmod2 == "Dimethyl" & DF_score_student < -1.3 ~ "Formyl",
        TRUE ~ NA_character_)
    )
}

{
  perc_prot <- perc_prot %>%
    mutate(
      nmod_welch = case_when(
        Nmod2 == "Acetyl" & TA_score_welch < -1.3 ~ "Acetyl",
        Nmod2 == "Acetyl" & between(TA_score_welch, -1.3, 1.3) ~ "Acetyl",
        Nmod2 == "Acetyl" & is.na(TA_score_welch) ~ "Acetyl",
        Nmod2 == "Acetyl" & TA_score_welch > 1.3 ~ "Trimethyl",
        Nmod2 == "Trimethyl" & TA_score_welch > 1.3 ~ "Trimethyl",
        Nmod2 == "Trimethyl" & between(TA_score_welch, -1.3, 1.3) ~ "Trimethyl",
        Nmod2 == "Trimethyl" & is.na(TA_score_welch) ~ "Trimethyl",
        Nmod2 == "Trimethyl" & TA_score_welch < -1.3 ~ "Acetyl",
        Nmod2 == "Formyl" & DF_score_welch < -1.3 ~ "Formyl",
        Nmod2 == "Formyl" & between(DF_score_welch, -1.3, 1.3) ~ "Formyl",
        Nmod2 == "Formyl" & is.na(DF_score_welch) ~ "Formyl",
        Nmod2 == "Formyl" & DF_score_welch > 1.3 ~ "Dimethyl",
        Nmod2 == "Dimethyl" & DF_score_welch > 1.3 ~ "Dimethyl",
        Nmod2 == "Dimethyl" & between(DF_score_welch, -1.3, 1.3) ~ "Dimethyl",
        Nmod2 == "Dimethyl" & is.na(DF_score_welch) ~ "Dimethyl",
        Nmod2 == "Dimethyl" & DF_score_welch < -1.3 ~ "Formyl",
        TRUE ~ NA_character_)
    )
}

{
  perc_prot <- perc_prot %>%
    mutate(
      nmod_mw = case_when(
        Nmod2 == "Acetyl" & TA_score_mw < -1.3 ~ "Acetyl",
        Nmod2 == "Acetyl" & between(TA_score_mw, -1.3, 1.3) ~ "Acetyl",
        Nmod2 == "Acetyl" & is.na(TA_score_mw) ~ "Acetyl",
        Nmod2 == "Acetyl" & TA_score_mw > 1.3 ~ "Trimethyl",
        Nmod2 == "Trimethyl" & TA_score_mw > 1.3 ~ "Trimethyl",
        Nmod2 == "Trimethyl" & between(TA_score_mw, -1.3, 1.3) ~ "Trimethyl",
        Nmod2 == "Trimethyl" & is.na(TA_score_mw) ~ "Trimethyl",
        Nmod2 == "Trimethyl" & TA_score_mw < -1.3 ~ "Acetyl",
        Nmod2 == "Formyl" & DF_score_mw < -1.3 ~ "Formyl",
        Nmod2 == "Formyl" & between(DF_score_mw, -1.3, 1.3) ~ "Formyl",
        Nmod2 == "Formyl" & is.na(DF_score_mw) ~ "Formyl",
        Nmod2 == "Formyl" & DF_score_mw > 1.3 ~ "Dimethyl",
        Nmod2 == "Dimethyl" & DF_score_mw > 1.3 ~ "Dimethyl",
        Nmod2 == "Dimethyl" & between(DF_score_mw, -1.3, 1.3) ~ "Dimethyl",
        Nmod2 == "Dimethyl" & is.na(DF_score_mw) ~ "Dimethyl",
        Nmod2 == "Dimethyl" & DF_score_mw < -1.3 ~ "Formyl",
        TRUE ~ NA_character_)
    )
}

{
  perc_prot <- perc_prot|>
  mutate(
      reassign_student = case_when(
        Nmod2 == "Acetyl" & TA_score_student < -1.3 ~ "acac",
        Nmod2 == "Acetyl" & between(TA_score_student, -1.3, 1.3) ~ "acna",
        Nmod2 == "Acetyl" & t_test_able_a == "unable" ~ "acna",
        Nmod2 == "Acetyl" & TA_score_student > 1.3 ~ "actm",
        Nmod2 == "Trimethyl" & TA_score_student > 1.3 ~ "tmtm",
        Nmod2 == "Trimethyl" & between(TA_score_student, -1.3, 1.3) ~ "tmna",
        Nmod2 == "Trimethyl" & t_test_able_a == "unable" ~ "tmna",
        Nmod2 == "Trimethyl" & TA_score_student < -1.3 ~ "tmac",
        Nmod2 == "Formyl" & DF_score_student < -1.3 ~ "fmfm",
        Nmod2 == "Formyl" & between(DF_score_student, -1.3, 1.3) ~ "fmna",
        Nmod2 == "Formyl" & t_test_able_a == "unable" ~ "fmna",
        Nmod2 == "Formyl" & DF_score_student > 1.3 ~ "fmdm",
        Nmod2 == "Dimethyl" & DF_score_student > 1.3 ~ "dmdm",
        Nmod2 == "Dimethyl" & between(DF_score_student, -1.3, 1.3) ~ "dmna",
        Nmod2 == "Dimethyl" & t_test_able_a == "unable" ~ "dmna",
        Nmod2 == "Dimethyl" & DF_score_student < -1.3 ~ "dmfm",
        TRUE ~ NA_character_),
      reassign_welch = case_when(
        Nmod2 == "Acetyl" & TA_score_welch < -1.3 ~ "acac",
        Nmod2 == "Acetyl" & between(TA_score_welch, -1.3, 1.3) ~ "acna",
        Nmod2 == "Acetyl" & t_test_able_a == "unable" ~ "acna",
        Nmod2 == "Acetyl" & TA_score_welch > 1.3 ~ "actm",
        Nmod2 == "Trimethyl" & TA_score_welch > 1.3 ~ "tmtm",
        Nmod2 == "Trimethyl" & between(TA_score_welch, -1.3, 1.3) ~ "tmna",
        Nmod2 == "Trimethyl" & t_test_able_a == "unable" ~ "tmna",
        Nmod2 == "Trimethyl" & TA_score_welch < -1.3 ~ "tmac",
        Nmod2 == "Formyl" & DF_score_welch < -1.3 ~ "fmfm",
        Nmod2 == "Formyl" & between(DF_score_welch, -1.3, 1.3) ~ "fmna",
        Nmod2 == "Formyl" & t_test_able_a == "unable" ~ "fmna",
        Nmod2 == "Formyl" & DF_score_welch > 1.3 ~ "fmdm",
        Nmod2 == "Dimethyl" & DF_score_welch > 1.3 ~ "dmdm",
        Nmod2 == "Dimethyl" & between(DF_score_welch, -1.3, 1.3) ~ "dmna",
        Nmod2 == "Dimethyl" & t_test_able_a == "unable" ~ "dmna",
        Nmod2 == "Dimethyl" & DF_score_welch < -1.3 ~ "dmfm",
        TRUE ~ NA_character_),
      reassign_mw = case_when(
        Nmod2 == "Acetyl" & TA_score_mw < -1.3 ~ "acac",
        Nmod2 == "Acetyl" & between(TA_score_mw, -1.3, 1.3) ~ "acna",
        Nmod2 == "Acetyl" & t_test_able_a == "unable" ~ "acna",
        Nmod2 == "Acetyl" & TA_score_mw > 1.3 ~ "actm",
        Nmod2 == "Trimethyl" & TA_score_mw > 1.3 ~ "tmtm",
        Nmod2 == "Trimethyl" & between(TA_score_mw, -1.3, 1.3) ~ "tmna",
        Nmod2 == "Trimethyl" & t_test_able_a == "unable" ~ "tmna",
        Nmod2 == "Trimethyl" & TA_score_mw < -1.3 ~ "tmac",
        Nmod2 == "Formyl" & DF_score_mw < -1.3 ~ "fmfm",
        Nmod2 == "Formyl" & between(DF_score_mw, -1.3, 1.3) ~ "fmna",
        Nmod2 == "Formyl" & t_test_able_a == "unable" ~ "fmna",
        Nmod2 == "Formyl" & DF_score_mw > 1.3 ~ "fmdm",
        Nmod2 == "Dimethyl" & DF_score_mw > 1.3 ~ "dmdm",
        Nmod2 == "Dimethyl" & between(DF_score_mw, -1.3, 1.3) ~ "dmna",
        Nmod2 == "Dimethyl" & t_test_able_a == "unable" ~ "dmna",
        Nmod2 == "Dimethyl" & DF_score_mw < -1.3 ~ "dmfm",
        TRUE ~ NA_character_)
      )

perc_prot <- perc_prot|>
  mutate(
    final_assign_student = case_when(
      reassign_student == "acac" | reassign_student == "acna" ~ "Acetyl",
      abs(ppm_near_iso) < 10 & reassign_student == "tmac" ~ "Acetyl",
      abs(ppm_near_iso) > 10 & reassign_student == "tmac" ~ "Trimethyl",
      reassign_student == "tmtm" | reassign_student == "tmna" ~ "Trimethyl",
      abs(ppm_near_iso) < 10 & reassign_student == "actm" ~ "Trimethyl",
      abs(ppm_near_iso) > 10 & reassign_student == "actm" ~ "Acetyl",
      reassign_student == "fmfm" | reassign_student == "fmna" ~ "Formyl",
      abs(ppm_near_iso) < 10 & reassign_student == "dmfm" ~ "Formyl",
      abs(ppm_near_iso) > 10 & reassign_student == "dmfm" ~ "Dimethyl",
      reassign_student == "dmdm" | reassign_student == "dmna" ~ "Dimethyl",
      abs(ppm_near_iso) < 10 & reassign_student == "fmdm" ~ "Dimethyl",
      abs(ppm_near_iso) > 10 & reassign_student == "fmdm" ~ "Formyl"
    ),
    final_assign_welch = case_when(
      reassign_welch == "acac" | reassign_welch == "acna" ~ "Acetyl",
      abs(ppm_near_iso) < 10 & reassign_welch == "tmac" ~ "Acetyl",
      abs(ppm_near_iso) > 10 & reassign_welch == "tmac" ~ "Trimethyl",
      reassign_welch == "tmtm" | reassign_welch == "tmna" ~ "Trimethyl",
      abs(ppm_near_iso) < 10 & reassign_welch == "actm" ~ "Trimethyl",
      abs(ppm_near_iso) > 10 & reassign_welch == "actm" ~ "Acetyl",
      reassign_welch == "fmfm" | reassign_welch == "fmna" ~ "Formyl",
      abs(ppm_near_iso) < 10 & reassign_welch == "dmfm" ~ "Formyl",
      abs(ppm_near_iso) > 10 & reassign_welch == "dmfm" ~ "Dimethyl",
      reassign_welch == "dmdm" | reassign_welch == "dmna" ~ "Dimethyl",
      abs(ppm_near_iso) < 10 & reassign_welch == "fmdm" ~ "Dimethyl",
      abs(ppm_near_iso) > 10 & reassign_welch == "fmdm" ~ "Formyl"
    ),
    final_assign_mw = case_when(
      reassign_mw == "acac" | reassign_mw == "acna" ~ "Acetyl",
      abs(ppm_near_iso) < 10 & reassign_mw == "tmac" ~ "Acetyl",
      abs(ppm_near_iso) > 10 & reassign_mw == "tmac" ~ "Trimethyl",
      reassign_mw == "tmtm" | reassign_mw == "tmna" ~ "Trimethyl",
      abs(ppm_near_iso) < 10 & reassign_mw == "actm" ~ "Trimethyl",
      abs(ppm_near_iso) > 10 & reassign_mw == "actm" ~ "Acetyl",
      reassign_mw == "fmfm" | reassign_mw == "fmna" ~ "Formyl",
      abs(ppm_near_iso) < 10 & reassign_mw == "dmfm" ~ "Formyl",
      abs(ppm_near_iso) > 10 & reassign_mw == "dmfm" ~ "Dimethyl",
      reassign_mw == "dmdm" | reassign_mw == "dmna" ~ "Dimethyl",
      abs(ppm_near_iso) < 10 & reassign_mw == "fmdm" ~ "Dimethyl",
      abs(ppm_near_iso) > 10 & reassign_mw == "fmdm" ~ "Formyl"
    )
  )
}

```